rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper validators
    function isAuthed() { return request.auth != null; }

    function isAdmin() { return isAuthed() && request.auth.token.admin == true; }
    function isManagerClaim() { return isAuthed() && request.auth.token.manager == true; }

    function validFirstName(name) {
      return name is string && name.size() >= 1 && name.size() <= 40 && name.matches('^[A-Za-z]{1,40}$');
    }
    function validLastName(name) {
      return name is string && name.size() >= 1 && name.size() <= 80 && name.matches('^[A-Za-z]+( [A-Za-z]+){0,2}$');
    }
    function validPhone(phone) {
      return phone is string && phone.matches('^\\d{10}$');
    }
    function validPincode(p) {
      return p is string && p.matches('^\\d{6}$');
    }

    // USERS - docId should be auth.uid
    match /users/{userId} {
      allow read: if isAuthed() && request.auth.uid == userId;
      allow create: if isAuthed() && request.auth.uid == userId
                    && request.resource.data.keys().hasOnly(['firstName','lastName','phoneNumber','isManager','isAdmin','isVerified','points','assignedBunkId'])
                    && validFirstName(request.resource.data.firstName)
                    && validLastName(request.resource.data.lastName)
                    && validPhone(request.resource.data.phoneNumber)
                    && request.resource.data.isManager == false
                    && request.resource.data.isAdmin == false
                    && request.resource.data.isVerified == true
                    && request.resource.data.points == 0
                    && request.resource.data.assignedBunkId == 'NA';

      // Users can update only a limited set of fields on their own profile (phoneNumber allowed to change, rest read-only).
      allow update: if isAuthed() && request.auth.uid == userId
                    && request.resource.data.keys().hasOnly(['phoneNumber','isVerified'])
                    && validPhone(request.resource.data.phoneNumber);

      // Admins can update profiles but must not set conflicting roles (enforce exclusivity here too)
      allow write: if isAdmin()
                    && request.resource.data.keys().hasOnly(['firstName','lastName','phoneNumber','isManager','isAdmin','isVerified','points','assignedBunkId'])
                    && validFirstName(request.resource.data.firstName)
                    && validLastName(request.resource.data.lastName)
                    && validPhone(request.resource.data.phoneNumber)
                    && !(request.resource.data.isManager == true && request.resource.data.isAdmin == true)
                    && (request.resource.data.points is number && request.resource.data.points >= 0);
    }

    // BUNKS
    match /bunks/{bunkId} {
      allow read: if true;
      allow write: if isAdmin()
                    && request.resource.data.keys().hasOnly(['name','location','district','state','pincode'])
                    && request.resource.data.name is string && request.resource.data.name.size() <= 100
                    && request.resource.data.location is string && request.resource.data.location.size() <= 50
                    && request.resource.data.district is string && request.resource.data.district.size() <= 50
                    && request.resource.data.state is string && request.resource.data.state.size() <= 50
                    && validPincode(request.resource.data.pincode);
    }

    // TRANSACTIONS - clients cannot write transactions directly; only server (functions) should create them
    match /transactions/{txnId} {
      allow read: if isAuthed() && (isAdmin() || resource.data.customerId == request.auth.uid || resource.data.managerId == request.auth.uid);
      allow create: if false; // prohibited for clients
      allow update, delete: if false;
    }

    // CONFIGS - read public, write by admin only
    match /configs/{configId} {
      allow read: if configId == 'global';
      allow write: if isAdmin()
                    && request.resource.data.keys().hasOnly(['creditPercentage','pointValue'])
                    && (request.resource.data.creditPercentage is number && request.resource.data.creditPercentage >= 0 && request.resource.data.creditPercentage <= 100)
                    && (request.resource.data.pointValue is number && request.resource.data.pointValue > 0);
    }
  }
}
